<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>NSCache를 이용해 이미지 캐싱하기 | 준모의 개발노트</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://jmpark6846.github.io/css/main.min.e34415025514319010e741089e6920454053855755ba465f66943ad102d2cb08.css></head><body><nav><header><div class=site-title><a href=/>준모의 개발노트</a></div></header><div class=nav-menu><a class="color-link nav-link" href=https://jmpark6846.github.io/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons></div><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p><script src=https://jmpark6846.github.io/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></nav><div id=content class=content-container><h1 class=post-title>NSCache를 이용해 이미지 캐싱하기</h1><time>August 17, 2023</time><div><p><p>이번엔 지난 글에 이어 파일로 불러온 이미지를 캐싱해서 사용하는 방법을 알아보자.</p><p>캐싱 자체는 복잡할 것이 없다. UIImage를 변수에 저장했다가 필요할때 꺼내 쓰는 것이다.</p><p>이미지의 주소 마다 이미지를 캐싱한다면 <code>[URL: UIImage]</code> 형태의 딕셔너리에 저장하는 것을 생각해볼 수 있다.</p><p>이 방법에는 단점이 있는데, 이미지 크기가 크거나 갯수가 많아지면 메모리를 많이 사용하여 문제가 된다는 것이다. 메모리를 많이 사용하는 문제를 해결하기 위해 사용하는 것이 <code>NSCache</code>이다.</p><p>NSCache는 일시적인 데이터를 담는 데 사용하는 집합 형태이다. 딕셔너리와 거의 동일하게 사용할 수 있다. 한 가지 큰 차이점이 있다면 메모리가 부족할때 자동으로 NSCache에 저장된 아이템을 제거하여 메모리를 회수한다는 것이다. 만약 데이터가 제거된다면 다시 불러오는 것은 개발자의 몫이다.</p><p>캐시에 저장되는 데이터의 크기나 갯수 cost를 정할 수 있다. 이 cost를 넘어가면 자동으로 항목을 제거하여 메모리를 회수한다.</p><p>이번엔 이미지를 캐싱하거나 캐시에서 꺼내올 역할을 해주는 ImageCache 를 만들어보자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ImageCache</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> shared = ImageCache()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>let</span> cache = NSCache&lt;NSURL, UIImage&gt;()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>직접적으로 캐시에 접근해서 데이터를 가져오는 메소드를 작성했다. 파라메터로 받은 주소에 이미지를 가져와 리턴한다. 해당 주소로 캐싱하지 않았다면 nil을 리턴한다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>image</span>(url: NSURL) -&gt; UIImage? {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cache.object(forKey: url)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>이번에는 해당 주소에 이미지가 있으면 이미지를 리턴하고 없으면 파일에서 읽어오는 메소드를 추가해보자.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getImage</span>(url: NSURL) -&gt; UIImage? {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> cachedImage = image(url: url) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cachedImage
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> image = ImageManager.shared.loadImage(url: url.absoluteURL!) {
</span></span><span style=display:flex><span>        cache.setObject(image, forKey: url)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> image
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>NSCache를 사용하기 위해서는 URL이 아닌 NSURL을 사용해야 한다. URL을 NSURL로 변환하는 메소드를 만들어 사용하였다. (<code>ImageManager</code>는 이전 글 참고)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>nsurl</span>(filename: String) -&gt; NSURL? {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> <span style=color:#66d9ef>let</span> url = ImageManager.shared.url(filename: filename) <span style=color:#66d9ef>else</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> NSURL(fileURLWithPath: url.path)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>아래는 최종 코드이다.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ImageCache</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> shared = ImageCache()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>let</span> cache = NSCache&lt;NSURL, UIImage&gt;()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>image</span>(url: NSURL) -&gt; UIImage? {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> cache.object(forKey: url)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getImage</span>(url: NSURL) -&gt; UIImage? {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> cachedImage = image(url: url) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> cachedImage
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> image = ImageManager.shared.loadImage(url: url.absoluteURL!) {
</span></span><span style=display:flex><span>            cache.setObject(image, forKey: url)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> image
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><div class=page-footer><hr class=footer-divider><a class=tag href=/tags/ios>#ios</a>
<a class=tag href=/tags/image>#image</a>
<a class=tag href=/tags/nscache>#NSCache</a></div></div><footer class=footer-mobile><div class=social-icons></div><div class=footer-mobile-links><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><span class=divider-bar>|</span><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p></div><script src=https://jmpark6846.github.io/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></body></html>